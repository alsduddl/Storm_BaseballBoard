<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kgitbank.spring.post.dao.IPostRepository" >

<!-- 마이페이지에서 자신의 글 확인 -->
<select id="getUserPost" parameterType="string" resultType="org.kgitbank.spring.post.vo.PostVO">
select post_id as postId,
user_id as userId,
title,
content,
seat_info as seatInfo,
cheer_score as cheerScore,
satisfaction_score as satisfactionScore,
content_date as contentDate,
is_notice as isNotice,
row_number() over(order by content_date desc) as user_post_num
from post
where user_id = #{userId}
</select>

<!-- 게시글 작성 -->
<insert id="insertPost" parameterType="org.kgitbank.spring.post.vo.PostVO">
insert into post(post_id, user_id, title, content, seat_info, cheer_score, satisfaction_score, is_notice)
values(post_seq.NEXTVAL, #{userId}, #{title}, #{content}, #{seatInfo, jdbcType=VARCHAR}, #{cheerScore, jdbcType=INTEGER}, #{satisfactionScore, jdbcType=INTEGER}, #{isNotice})
</insert>

<!-- 게시글 목록 -->
<select id="getPostList" resultType="org.kgitbank.spring.post.vo.PostListVO">
select
p.post_id as postId,
p.title,
p.user_id as userId,
u.role as userRole,
p.content_date as contentDate,
p.is_notice as isNotice,
count(l.post_id) as likeCount
from post p
join users u on p.user_id = u.user_id
left join postlike l on p.post_id = l.post_id
group by p.post_id, p.title, p.user_id, u.role, p.content_date, p.is_notice
order by 
case when u.role = 'ADMIN' then 0 else 1 end,
p.content_date desc
</select>

<!-- 게시글 상세 -->
<select id="getPostDetail" parameterType="int" resultType="org.kgitbank.spring.post.vo.PostVO">
select p.post_id as postId,
p.user_id as userId,
p.title,
p.content,
p.seat_info as seatInfo,
p.cheer_score as cheerScore,
p.satisfaction_score as satisfactionScore,
p.content_date as contentDate,
p.is_notice as isNotice,
(case when p.is_notice = 'Y' then 0
else (select count(*) from postlike l where l.post_id = p.post_id)
end) as likeCount
from post p
where p.post_id = #{postId}
</select>

<!-- 게시글 수정 -->
<update id="updatePost" parameterType="org.kgitbank.spring.post.vo.PostVO">
update post
set
title = #{title},
seat_info = #{seatInfo, jdbcType=VARCHAR},
content = #{content},
cheer_score = #{cheerScore, jdbcType=INTEGER},
satisfaction_score = #{satisfactionScore, jdbcType=INTEGER},
is_notice = #{isNotice, jdbcType=CHAR}
where post_id = #{postId}
</update>

<!-- 게시글 삭제 -->
<delete id="deletePost" parameterType="int">
delete from post
where post_id = #{postId}
</delete>

<!-- 회원 게시글 목록 -->
<select id="getUserPostList" resultType="org.kgitbank.spring.post.vo.PostListVO">
select row_number() over(order by p.post_id desc) as postListSn,
p.post_id as postId,
p.title,
p.user_id as userId,
p.content_date as contentDate,
p.is_notice as isNotice,
count(l.post_id) as likeCount
from post p
left join postlike l 
on p.post_id = l.post_id
where p.user_id = #{user_id}
group by p.post_id, p.title, p.user_id, p.content_date, p.is_notice
order by p.post_id desc
</select>

<resultMap id="topLikePostMap" type="org.kgitbank.spring.post.vo.PostListVO">
    <result property="postListSn" column="postListSn"/>
    <result property="postId" column="post_id"/>
    <result property="title" column="title"/>
    <result property="userId" column="user_id"/>
    <result property="contentDate" column="content_date"/>
    <result property="likeCount" column="likeCount"/>
    <result property="userRole" column="user_role"/>
</resultMap>

<!-- 메인페이지 좋아요수TOP5 -->
<select id="getTopLikePost" resultMap="topLikePostMap">
select
postListSn,
post_id,
title,
user_id,
user_role,
content_date,
likeCount
from (
select
row_number() over (order by count(l.post_id) desc, p.content_date desc) as postListSn,
p.post_id,
p.title,
p.user_id,
u.role as user_role,
p.content_date,
count(l.post_id) as likeCount
from post p
join users u on p.user_id = u.user_id
left join postlike l on p.post_id = l.post_id
where u.role != 'ADMIN' 
group by p.post_id, p.title, p.user_id, u.role, p.content_date
order by likeCount desc )
where rownum &lt;= 5
</select>

<!-- 메인페이지 최신 게시글 -->
<select id="getMainPostList" resultType="org.kgitbank.spring.post.vo.PostListVO">
select *
from (
select
p.post_id as postId,
p.title,
p.user_id as userId,
u.role as userRole,
p.content_date as contentDate,
p.is_notice as isNotice,
(select count(*) from postlike l where l.post_id = p.post_id) as likeCount
from post p
left join users u on p.user_id = u.user_id
order by 
(case when p.is_notice = 'Y' then 0 else 1 end) asc,
p.content_date desc
)
where rownum &lt;= 7
</select>

</mapper>